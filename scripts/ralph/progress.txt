# Ralph Progress Log - Athlete OS
Started: 2026-01-11

## Codebase Patterns

### File Structure
- Athlete data: `athletes/{name}/athlete_state.json` (live state)
- Athlete config: `athletes/{name}/profile.yaml` (static profile)
- Scripts: `scripts/` directory, Python 3.11+
- Frameworks: `knowledge/frameworks/*.md` (domain knowledge)
- Archetypes: `knowledge/archetypes/` (workout library, git submodule)

### State File Conventions
- Always update `_meta.last_updated` with ISO timestamp
- Always update `_meta.updated_by` with script name
- Use `datetime.now(timezone.utc).isoformat()` for timestamps

### Script Patterns (from calculate_readiness.py)
```python
from pathlib import Path
import argparse
import json

def main():
    parser = argparse.ArgumentParser(description='...')
    parser.add_argument('athlete_name', help='Athlete folder name')
    parser.add_argument('--verbose', '-v', action='store_true')
    args = parser.parse_args()

    # Find athlete directory
    base_dir = Path(__file__).parent.parent
    athlete_dir = base_dir / "athletes" / args.athlete_name
    state_file = athlete_dir / "athlete_state.json"

    with open(state_file) as f:
        state = json.load(f)

    # ... do work ...

    # Save state
    with open(state_file, 'w') as f:
        json.dump(state, f, indent=2)

if __name__ == "__main__":
    main()
```

### Readiness Thresholds
- Key session eligible: score >= 70
- Support session: score 45-70
- Recovery only: score < 45
- Thresholds stored in `readiness.threshold_key_session` and `readiness.threshold_support_session`

### Health Gates
Five domains, all must pass for intensity:
1. sleep - min 7 hours, debt check
2. energy - weight trend, appetite
3. autonomic - HRV/RHR vs baseline, ANS quadrant
4. musculoskeletal - soreness, asymmetry, injury signals
5. stress - life stress, cognitive fatigue

### Zone Distribution Targets
- Z1-Z2: 84%
- G-Spot (Z3): 6%
- Z4+: 10%

### Key Files to Reference
- `scripts/calculate_readiness.py` - readiness scoring pattern
- `scripts/daily_briefing.py` - output formatting pattern
- `knowledge/frameworks/READINESS_ENGINE.md` - readiness logic
- `knowledge/frameworks/WEEKLY_PLANNING_ENGINE.md` - planning logic

---
## Iteration Log

---
## 2026-01-11 - P1-001
**Implemented:** Weekly Intent Generator script
**Files changed:**
- scripts/generate_weekly_intent.py (created)
- athletes/matti-rowe/weekly_intent.json (created)
**Learnings:**
- Profile uses YAML (pyyaml), state uses JSON
- TSB determines fatigue status: fresh (>5), normal (-5 to 5), tired (-15 to -5), exhausted (<-25)
- Phase modifiers affect volume/intensity bias (base phase = more volume, less intensity)
- Weekly intent outputs to `athletes/{name}/weekly_intent.json` with `_meta` block
- Key sessions are reduced when fatigued (TSB low) even if readiness is high
- Priority rule changes based on fatigue: "respond > complete" → "recover > respond > complete"

---
## 2026-01-11 - P1-002
**Implemented:** Daily Session Recommender script
**Files changed:**
- scripts/recommend_session.py (created)
**Learnings:**
- Archetype library in knowledge/archetypes/zwo_output_cleaned/ contains ~1100 ZWO files
- ZWO files organized by category (VO2max, Endurance, Tempo_G-Spot, etc.)
- Phase priorities guide archetype selection (base → endurance/gspot, build → threshold/vo2max)
- Health gates are checked first - any failure blocks intensity regardless of readiness score
- Weekly intent integration allows tracking key sessions remaining
- random.choice() used for archetype selection - could be improved with smarter matching later
- Archetype metadata (duration, TSS estimate) hardcoded - could parse from ZWO files in future

---
## 2026-01-11 - P2-001
**Implemented:** Alert Engine script
**Files changed:**
- scripts/check_alerts.py (created)
- athletes/matti-rowe/athlete_state.json (updated)
**Learnings:**
- Alert structure: {type, severity, message, value, threshold, recommendation, detected_at}
- Severity levels: info (1), warning (2), critical (3) - used for sorting
- Alert resolution: compare base type (strip _warning/_critical suffix) to detect resolved
- Zone distribution data may be 0% if no recent training synced
- HRV decline calculated as (baseline - current) / baseline * 100
- Resolved alerts kept in resolved_recently (limit 10) for history
- Always update _meta.updated_by when modifying state

---
## 2026-01-11 - P3-001
**Implemented:** Weekly Review Generator script
**Files changed:**
- scripts/weekly_review.py (created)
**Learnings:**
- Compliance rating: excellent (90%+), good (80%+), fair (70%+), poor (<70%)
- Zone tolerance: Z1-Z2 ±10%, Z3 ±5%, Z4+ ±5% from targets
- TSB ranges: fresh (5-25), optimal (-10 to 5), tired (-20 to -10), exhausted (<-20)
- Wins/flags pattern: analyze multiple data sources, identify positive and concerning signals
- Suggestions derived from: TSB level, compliance trend, zone drift, recovery metrics
- Format function separates data generation from presentation - enables multiple output formats
- Weekly intent integration provides context for key session targets

---
## 2026-01-11 - P3-002
**Implemented:** Race Countdown Dashboard script
**Files changed:**
- scripts/race_countdown.py (created)
**Learnings:**
- Race info in profile.yaml under goals.primary_event (name, date, distance_km, elevation_m, target_time)
- CTL trajectory targets: 50% at 16wk, 65% at 12wk, 80% at 8wk, 95% at 4wk (peak), then taper
- Target CTL by event: 100mi=70, 200mi=85, ultra(300km+)=100
- Milestones calculated as weeks before race: peak_volume=6, peak_intensity=4, taper_start=2
- Risk assessment combines: CTL vs trajectory, TSB, ramp rate, compliance, readiness, time remaining
- Projection uses simple linear model: current_ctl + (ramp_rate * build_weeks) - taper_reduction
- Visual progress bar uses unicode blocks: █ for filled, ░ for empty

---
## 2026-01-11 - TD-001
**Implemented:** JSON Schema Validation
**Files changed:**
- schemas/athlete_state.schema.json (created)
- scripts/validate_state.py (created)
**Learnings:**
- JSON Schema Draft 2020-12 uses $defs for reusable definitions (factors, alerts)
- jsonschema library: Draft202012Validator, iter_errors() for collecting all errors
- Business rules validation separate from schema: TSB=CTL-ATL, gate consistency
- Schema required fields: _meta, readiness, health_gates, performance_management
- Each health gate requires gate_pass boolean
- Exit code 1 on failure makes script CI-friendly
- Type unions in JSON Schema: "type": ["string", "null"] for nullable fields

---
## 2026-01-11 - TD-002
**Implemented:** Unit Tests for Profile Manager
**Files changed:**
- tests/test_profile_manager.py (created)
**Learnings:**
- pytest fixtures with tmp_path provide isolated temp directories
- Use unittest.mock.patch to override module-level constants (ATHLETES_DIR)
- Create template and test athlete in fixture setup
- Test groups: helpers, list, read, update, create, delete, context
- 29 tests cover all CRUD operations
- shutil.copytree for copying template to new athlete

---
## 2026-01-11 - TD-003
**Implemented:** Intervals.icu Setup Documentation
**Files changed:**
- docs/SETUP_INTERVALS.md (created)
**Learnings:**
- API key from: Intervals.icu → Settings → Developer Settings
- Athlete ID format: "i12345" (or "i0" for self)
- Auth: HTTPBasicAuth("API_KEY", actual_key)
- Key endpoints: /wellness (PMC), /activities, /streams
- Common errors: 401 (bad key), 404 (bad athlete ID)
- Rate limits generous but avoid tight loops

