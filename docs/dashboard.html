<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Athlete Dashboard | Situation Station</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sometype+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --black: #000;
            --white: #fff;
            --cream: #F5F5DC;
            --green: #00FF00;
            --yellow: #FFD700;
            --red: #FF3333;
            --muted: #666;
            --light-gray: #f0f0f0;
            --border-width: 3px;

            /* Intervals.icu-inspired PMC colors */
            --ctl-blue: #2196F3;
            --atl-pink: #E91E63;
            --tsb-yellow: #FFC107;
            --load-purple: #9C27B0;

            /* TSB zone backgrounds */
            --tsb-fresh: rgba(76, 175, 80, 0.15);
            --tsb-optimal: rgba(76, 175, 80, 0.25);
            --tsb-gray: rgba(158, 158, 158, 0.15);
            --tsb-risk: rgba(244, 67, 54, 0.2);

            /* Training zone colors (Zwift/Garmin standard) */
            --zone1: #9E9E9E;
            --zone2: #2196F3;
            --zone3: #4CAF50;
            --zone4: #FFC107;
            --zone5: #F44336;
            --zone6: #9C27B0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Sometype Mono', ui-monospace, 'SF Mono', monospace;
            background: var(--white);
            color: var(--black);
            line-height: 1.5;
            font-size: 14px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0;
            border-left: var(--border-width) solid var(--black);
            border-right: var(--border-width) solid var(--black);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--black);
            color: var(--white);
            padding: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            margin-bottom: 4px;
        }

        .header .date {
            font-size: 12px;
            color: var(--muted);
            letter-spacing: 0.1em;
        }

        .header .athlete-name {
            font-size: 18px;
            font-weight: 700;
            margin-top: 12px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        /* Section styling */
        .section {
            border-bottom: var(--border-width) solid var(--black);
            padding: 24px;
        }

        .section-header {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--muted);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--black);
        }

        /* Hero Readiness Section */
        .readiness-hero {
            text-align: center;
            padding: 32px 24px;
        }

        .readiness-score {
            font-size: 72px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .readiness-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.2em;
            color: var(--muted);
        }

        .readiness-status {
            display: inline-block;
            padding: 8px 16px;
            margin-top: 16px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 2px solid var(--black);
        }

        .readiness-status.green {
            background: var(--green);
            color: var(--black);
        }

        .readiness-status.yellow {
            background: var(--yellow);
            color: var(--black);
        }

        .readiness-status.red {
            background: var(--red);
            color: var(--white);
        }

        .ans-badge {
            display: inline-block;
            padding: 6px 12px;
            margin-top: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            background: var(--black);
            color: var(--white);
        }

        /* Data Freshness Banner */
        .data-freshness {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border-bottom: 2px solid var(--black);
        }

        .data-freshness.fresh {
            background: var(--cream);
            color: var(--black);
        }

        .data-freshness.stale {
            background: var(--yellow);
            color: var(--black);
        }

        .data-freshness.very-stale {
            background: var(--red);
            color: var(--white);
        }

        .freshness-icon {
            font-size: 14px;
        }

        .freshness-text {
            font-weight: 600;
        }

        .freshness-action {
            margin-left: 8px;
            padding: 4px 8px;
            background: var(--black);
            color: var(--white);
            text-decoration: none;
            font-size: 9px;
        }

        .freshness-action:hover {
            background: var(--muted);
        }

        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--black);
            color: var(--white);
            padding: 8px 16px;
            z-index: 100;
            text-decoration: none;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Visually hidden but accessible */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Score breakdown */
        .score-breakdown {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--light-gray);
        }

        .factor-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 12px;
            border-bottom: 1px solid var(--light-gray);
        }

        .factor-name {
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .factor-value {
            font-weight: 600;
        }

        .factor-value.positive { color: #00AA00; }
        .factor-value.negative { color: var(--red); }

        /* Health Gates */
        .gates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .gate-item {
            border: 2px solid var(--black);
            padding: 12px;
            text-align: center;
        }

        .gate-item.pass {
            background: var(--cream);
        }

        .gate-item.fail {
            background: var(--red);
            color: var(--white);
        }

        .gate-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .gate-name {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .gate-detail {
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px;
        }

        .gate-item.fail .gate-detail {
            color: var(--white);
        }

        .gates-overall {
            margin-top: 16px;
            padding: 12px;
            background: var(--black);
            color: var(--white);
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Session Recommendation */
        .session-type {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--muted);
            margin-bottom: 8px;
        }

        .session-workout {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 16px;
        }

        .session-meta {
            display: flex;
            gap: 24px;
            margin-bottom: 16px;
        }

        .session-meta-item {
            font-size: 12px;
        }

        .session-meta-label {
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .session-meta-value {
            font-weight: 700;
        }

        .session-rationale {
            border-left: 3px solid var(--black);
            padding-left: 12px;
            margin-top: 16px;
        }

        .rationale-item {
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--muted);
        }

        /* PMC Metrics */
        .pmc-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0;
            border: 2px solid var(--black);
        }

        .pmc-item {
            padding: 16px;
            text-align: center;
            border-right: 2px solid var(--black);
        }

        .pmc-item:last-child {
            border-right: none;
        }

        .pmc-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .pmc-value {
            font-size: 28px;
            font-weight: 700;
        }

        .pmc-sublabel {
            font-size: 9px;
            color: var(--muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .pmc-extra {
            margin-top: 16px;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .pmc-extra-label {
            color: var(--muted);
        }

        /* Zone Distribution */
        .zone-bars {
            margin-top: 16px;
        }

        .zone-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .zone-label {
            width: 60px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .zone-bar-container {
            flex: 1;
            height: 20px;
            background: var(--light-gray);
            border: 1px solid var(--black);
            position: relative;
        }

        .zone-bar-fill {
            height: 100%;
            background: var(--black);
        }

        .zone-bar-target {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: var(--red);
        }

        .zone-value {
            width: 60px;
            text-align: right;
            font-size: 11px;
            font-weight: 600;
        }

        /* Blindspots */
        .blindspot-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }

        .blindspot-tag {
            padding: 6px 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: var(--black);
            color: var(--white);
        }

        .adjustments-table {
            width: 100%;
            font-size: 12px;
            border-collapse: collapse;
        }

        .adjustments-table td {
            padding: 8px 0;
            border-bottom: 1px solid var(--light-gray);
        }

        .adjustments-table td:last-child {
            text-align: right;
            font-weight: 600;
        }

        .reminders {
            margin-top: 16px;
            padding: 12px;
            background: var(--cream);
            border: 2px solid var(--black);
        }

        .reminder-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .reminder-item {
            font-size: 12px;
            margin-bottom: 6px;
            padding-left: 16px;
            position: relative;
        }

        .reminder-item::before {
            content: "→";
            position: absolute;
            left: 0;
        }

        /* Race Countdown */
        .race-countdown {
            text-align: center;
        }

        .race-name {
            font-size: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .race-date {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 16px;
        }

        .days-to-race {
            font-size: 48px;
            font-weight: 700;
            line-height: 1;
        }

        .days-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--muted);
        }

        .ctl-progress {
            margin-top: 24px;
            padding: 16px;
            background: var(--light-gray);
            border: 2px solid var(--black);
        }

        .ctl-progress-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .ctl-bar {
            height: 24px;
            background: var(--white);
            border: 2px solid var(--black);
            position: relative;
        }

        .ctl-bar-fill {
            height: 100%;
            background: var(--green);
        }

        .ctl-values {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 11px;
        }

        /* Weekly Intent */
        .intent-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .intent-item {
            padding: 12px;
            border: 2px solid var(--black);
        }

        .intent-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .intent-value {
            font-size: 18px;
            font-weight: 700;
        }

        .intent-value small {
            font-size: 12px;
            font-weight: 400;
            color: var(--muted);
        }

        /* Alerts */
        .alert-item {
            padding: 12px;
            margin-bottom: 8px;
            border: 2px solid var(--red);
            background: #fff5f5;
        }

        .alert-item.resolved {
            border-color: var(--muted);
            background: var(--light-gray);
        }

        .no-alerts {
            text-align: center;
            padding: 24px;
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Footer */
        .footer {
            padding: 24px;
            text-align: center;
            font-size: 11px;
            color: var(--muted);
            background: var(--light-gray);
        }

        .footer a {
            color: var(--black);
        }

        /* Loading state */
        .loading {
            text-align: center;
            padding: 48px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            border-bottom: var(--border-width) solid var(--black);
        }

        .tab {
            flex: 1;
            padding: 16px 24px;
            font-family: 'Sometype Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            background: var(--white);
            color: var(--black);
            border: none;
            border-right: 2px solid var(--black);
            cursor: pointer;
            transition: background 0.1s, color 0.1s;
        }

        .tab:last-child {
            border-right: none;
        }

        .tab:hover {
            background: var(--light-gray);
        }

        .tab.active {
            background: var(--black);
            color: var(--white);
        }

        .tab:focus {
            outline: 2px solid var(--black);
            outline-offset: -2px;
        }

        /* Views */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        /* Calendar View */
        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 2px solid var(--black);
        }

        .calendar-nav-btn {
            padding: 8px 16px;
            font-family: 'Sometype Mono', monospace;
            font-size: 14px;
            font-weight: 700;
            background: var(--white);
            border: 2px solid var(--black);
            cursor: pointer;
        }

        .calendar-nav-btn:hover {
            background: var(--black);
            color: var(--white);
        }

        .calendar-month-label {
            font-size: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-bottom: 2px solid var(--black);
        }

        .calendar-header {
            padding: 12px 4px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-align: center;
            background: var(--light-gray);
            border-right: 1px solid var(--light-gray);
            border-bottom: 2px solid var(--black);
        }

        .calendar-header:last-child {
            border-right: none;
        }

        .calendar-day {
            min-height: 80px;
            padding: 8px;
            border-right: 1px solid var(--light-gray);
            border-bottom: 1px solid var(--light-gray);
            position: relative;
        }

        .calendar-day:nth-child(7n) {
            border-right: none;
        }

        .calendar-day.empty {
            background: var(--light-gray);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: var(--cream);
            border: 2px solid var(--black);
        }

        .calendar-day.race-day {
            background: #fff3cd;
        }

        .calendar-day-number {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .calendar-workout {
            font-size: 9px;
            padding: 3px 5px;
            margin-bottom: 3px;
            background: var(--black);
            color: var(--white);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .calendar-workout.planned {
            background: var(--white);
            color: var(--black);
            border: 1px solid var(--black);
        }

        .calendar-race {
            font-size: 9px;
            padding: 3px 5px;
            background: var(--red);
            color: var(--white);
            font-weight: 700;
            text-transform: uppercase;
        }

        .calendar-tss {
            font-size: 9px;
            color: var(--muted);
        }

        .calendar-legend {
            display: flex;
            gap: 24px;
            padding: 16px 24px;
            font-size: 10px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-swatch {
            width: 16px;
            height: 16px;
            border: 1px solid var(--black);
        }

        .legend-swatch.completed { background: var(--black); }
        .legend-swatch.planned { background: var(--white); }
        .legend-swatch.race { background: var(--red); }
        .legend-swatch.today { background: var(--cream); }

        /* Trends View */
        .trends-section {
            padding: 24px;
            border-bottom: var(--border-width) solid var(--black);
        }

        .trends-header {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--muted);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--black);
        }

        .trend-chart {
            width: 100%;
            height: 250px;
            border: 2px solid var(--black);
            background: var(--white);
        }

        .chart-legend {
            display: flex;
            gap: 24px;
            margin-top: 12px;
            font-size: 10px;
            justify-content: center;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chart-legend-line {
            width: 20px;
            height: 3px;
        }

        .chart-legend-line.ctl { background: var(--ctl-blue); }
        .chart-legend-line.atl { background: var(--atl-pink); }
        .chart-legend-line.tsb { background: var(--tsb-yellow); }
        .chart-legend-line.load { background: var(--load-purple); }

        /* Activity intensity mini-bar (skyline-inspired) */
        .activity-intensity {
            display: flex;
            height: 16px;
            gap: 1px;
            margin-top: 4px;
        }

        .intensity-bar {
            flex: 1;
            min-width: 3px;
        }

        .intensity-bar.z1 { background: var(--zone1); }
        .intensity-bar.z2 { background: var(--zone2); }
        .intensity-bar.z3 { background: var(--zone3); }
        .intensity-bar.z4 { background: var(--zone4); }
        .intensity-bar.z5 { background: var(--zone5); }
        .intensity-bar.z6 { background: var(--zone6); }

        /* Weekly progress bar */
        .weekly-progress {
            padding: 12px 24px;
            border-bottom: 2px solid var(--black);
            background: var(--light-gray);
        }

        .progress-label {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .progress-bar-container {
            height: 20px;
            background: var(--white);
            border: 2px solid var(--black);
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-bar-fill.under { background: var(--zone2); }
        .progress-bar-fill.on-target { background: var(--zone3); }
        .progress-bar-fill.over { background: var(--tsb-yellow); }

        .progress-target-line {
            position: absolute;
            top: 0;
            height: 100%;
            width: 2px;
            background: var(--black);
        }

        /* Load bar (stacked at top of PMC chart) */
        .load-bars {
            display: flex;
            height: 40px;
            gap: 1px;
            margin-bottom: 8px;
            align-items: flex-end;
            border-bottom: 1px solid var(--light-gray);
        }

        .load-bar {
            flex: 1;
            background: var(--load-purple);
            min-width: 2px;
        }

        .chart-no-data {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--muted);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            border: 2px solid var(--black);
            background: var(--light-gray);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
            border: 2px solid var(--black);
            margin-top: 16px;
        }

        .stat-item {
            padding: 16px;
            text-align: center;
            border-right: 2px solid var(--black);
        }

        .stat-item:last-child {
            border-right: none;
        }

        .stat-label {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
        }

        @media (max-width: 600px) {
            .tabs {
                flex-direction: column;
            }

            .tab {
                border-right: none;
                border-bottom: 2px solid var(--black);
            }

            .tab:last-child {
                border-bottom: none;
            }

            .calendar-day {
                min-height: 60px;
                padding: 4px;
            }

            .calendar-day-number {
                font-size: 10px;
            }

            .calendar-workout {
                font-size: 8px;
                padding: 2px 3px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .stat-item {
                border-bottom: 2px solid var(--black);
            }

            .stat-item:nth-child(2),
            .stat-item:nth-child(4) {
                border-right: none;
            }

            .stat-item:nth-child(3),
            .stat-item:nth-child(4) {
                border-bottom: none;
            }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                border-left: none;
                border-right: none;
            }

            .section {
                padding: 16px;
            }

            .readiness-score {
                font-size: 56px;
            }

            .pmc-grid {
                grid-template-columns: 1fr;
            }

            .pmc-item {
                border-right: none;
                border-bottom: 2px solid var(--black);
            }

            .pmc-item:last-child {
                border-bottom: none;
            }

            .gates-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .session-meta {
                flex-direction: column;
                gap: 8px;
            }

            .intent-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Skip link for keyboard navigation -->
    <a href="#readiness-section" class="skip-link">Skip to main content</a>

    <div class="container" role="main">
        <header class="header" role="banner">
            <h1>Situation Station</h1>
            <div class="date" id="current-date" aria-label="Current date">Loading...</div>
            <div class="athlete-name" id="athlete-name" aria-label="Athlete name">--</div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tabs" role="tablist" aria-label="Dashboard views">
            <button class="tab active" data-view="today" role="tab" aria-selected="true" aria-controls="view-today">Today</button>
            <button class="tab" data-view="calendar" role="tab" aria-selected="false" aria-controls="view-calendar">Calendar</button>
            <button class="tab" data-view="trends" role="tab" aria-selected="false" aria-controls="view-trends">Trends</button>
        </nav>

        <!-- TODAY VIEW -->
        <div class="view active" id="view-today" role="tabpanel" aria-labelledby="tab-today">

        <!-- Data Freshness Banner -->
        <div class="data-freshness fresh" id="data-freshness" role="status" aria-live="polite">
            <span class="freshness-icon" aria-hidden="true">●</span>
            <span class="freshness-text" id="freshness-text">Checking data...</span>
            <span class="sr-only" id="freshness-sr">Data status loading</span>
        </div>

        <!-- Readiness Hero -->
        <section class="section readiness-hero" id="readiness-section" aria-labelledby="readiness-heading">
            <h2 id="readiness-heading" class="sr-only">Readiness Score</h2>
            <div class="readiness-score" id="readiness-score" aria-describedby="readiness-description">--</div>
            <div class="readiness-label" id="readiness-description">Readiness Score</div>
            <div class="readiness-status" id="readiness-status" role="status" aria-live="polite">Loading</div>
            <span class="sr-only" id="readiness-sr">Loading readiness data</span>
            <div><span class="ans-badge" id="ans-badge" aria-label="ANS Quadrant status">--</span></div>

            <div class="score-breakdown" id="score-breakdown" aria-label="Score factor breakdown">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Health Gates -->
        <section class="section" aria-labelledby="gates-heading">
            <h2 id="gates-heading" class="section-header">Health Gates</h2>
            <div class="gates-grid" id="gates-grid" role="list" aria-label="Health gate status for each category">
                <!-- Populated by JS -->
            </div>
            <div class="gates-overall" id="gates-overall" role="status" aria-live="polite">--</div>
        </section>

        <!-- Today's Session -->
        <section class="section">
            <div class="section-header">Today's Session</div>
            <div class="session-type" id="session-type">--</div>
            <div class="session-workout" id="session-workout">--</div>
            <div class="session-meta" id="session-meta">
                <!-- Populated by JS -->
            </div>
            <div class="session-rationale" id="session-rationale">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- PMC / Training Load -->
        <section class="section">
            <div class="section-header">Training Load</div>
            <div class="pmc-grid" id="pmc-grid">
                <div class="pmc-item">
                    <div class="pmc-label">CTL</div>
                    <div class="pmc-value" id="pmc-ctl">--</div>
                    <div class="pmc-sublabel">Fitness</div>
                </div>
                <div class="pmc-item">
                    <div class="pmc-label">ATL</div>
                    <div class="pmc-value" id="pmc-atl">--</div>
                    <div class="pmc-sublabel">Fatigue</div>
                </div>
                <div class="pmc-item">
                    <div class="pmc-label">TSB</div>
                    <div class="pmc-value" id="pmc-tsb">--</div>
                    <div class="pmc-sublabel" id="tsb-status">Form</div>
                </div>
            </div>
            <div class="pmc-extra">
                <div>
                    <span class="pmc-extra-label">Ramp Rate:</span>
                    <span id="ramp-rate">--</span> TSS/day
                </div>
                <div>
                    <span class="pmc-extra-label">Trend:</span>
                    <span id="trend">--</span>
                </div>
            </div>
        </section>

        <!-- Recent Training -->
        <section class="section">
            <div class="section-header">Recent Training (7 Days)</div>
            <div class="pmc-extra" style="margin-bottom: 16px;">
                <div>
                    <span class="pmc-extra-label">Total TSS:</span>
                    <span id="total-tss">--</span>
                </div>
                <div>
                    <span class="pmc-extra-label">Hours:</span>
                    <span id="total-hours">--</span>
                </div>
                <div>
                    <span class="pmc-extra-label">Workouts:</span>
                    <span id="workouts-count">--</span>
                </div>
            </div>
            <div class="zone-bars" id="zone-bars">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Blindspots -->
        <section class="section" id="blindspots-section">
            <div class="section-header">Active Blindspots</div>
            <div class="blindspot-list" id="blindspot-list">
                <!-- Populated by JS -->
            </div>
            <table class="adjustments-table" id="adjustments-table">
                <!-- Populated by JS -->
            </table>
            <div class="reminders" id="reminders" style="display: none;">
                <div class="reminder-title">Today's Reminders</div>
                <div id="reminders-list">
                    <!-- Populated by JS -->
                </div>
            </div>
        </section>

        <!-- Weekly Intent -->
        <section class="section" id="weekly-intent-section" style="display: none;">
            <div class="section-header">Weekly Intent</div>
            <div class="intent-grid" id="intent-grid">
                <!-- Populated by JS -->
            </div>
        </section>

        <!-- Race Countdown -->
        <section class="section race-countdown" id="race-section" style="display: none;">
            <div class="section-header">A-Race Countdown</div>
            <div class="race-name" id="race-name">--</div>
            <div class="race-date" id="race-date">--</div>
            <div class="days-to-race" id="days-to-race">--</div>
            <div class="days-label">Days to Go</div>
            <div class="ctl-progress">
                <div class="ctl-progress-label">CTL Progress to Target</div>
                <div class="ctl-bar">
                    <div class="ctl-bar-fill" id="ctl-bar-fill" style="width: 0%;"></div>
                </div>
                <div class="ctl-values">
                    <span>Current: <strong id="ctl-current">--</strong></span>
                    <span>Target: <strong id="ctl-target">--</strong></span>
                </div>
            </div>
        </section>

        <!-- Alerts -->
        <section class="section">
            <div class="section-header">Alerts</div>
            <div id="alerts-container">
                <div class="no-alerts">No active alerts</div>
            </div>
        </section>

        </div><!-- End TODAY VIEW -->

        <!-- CALENDAR VIEW -->
        <div class="view" id="view-calendar" role="tabpanel" aria-labelledby="tab-calendar">
            <!-- Weekly Progress Bar -->
            <div class="weekly-progress" id="weekly-progress">
                <div class="progress-label">
                    <span>Weekly TSS Progress</span>
                    <span id="weekly-progress-text">0 / 0 TSS</span>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar-fill on-target" id="weekly-progress-fill" style="width: 0%"></div>
                    <div class="progress-target-line" id="weekly-target-line" style="left: 100%"></div>
                </div>
            </div>

            <div class="calendar-nav">
                <button class="calendar-nav-btn" id="prev-month" aria-label="Previous month">◀ Prev</button>
                <span class="calendar-month-label" id="calendar-month-label">January 2026</span>
                <button class="calendar-nav-btn" id="next-month" aria-label="Next month">Next ▶</button>
            </div>
            <div class="calendar-grid" id="calendar-grid" role="grid" aria-label="Training calendar">
                <div class="calendar-header" role="columnheader">Mon</div>
                <div class="calendar-header" role="columnheader">Tue</div>
                <div class="calendar-header" role="columnheader">Wed</div>
                <div class="calendar-header" role="columnheader">Thu</div>
                <div class="calendar-header" role="columnheader">Fri</div>
                <div class="calendar-header" role="columnheader">Sat</div>
                <div class="calendar-header" role="columnheader">Sun</div>
                <!-- Days populated by JS -->
            </div>
            <div class="calendar-legend">
                <div class="legend-item">
                    <div class="legend-swatch completed"></div>
                    <span>Completed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-swatch race"></div>
                    <span>Race</span>
                </div>
                <div class="legend-item">
                    <div class="legend-swatch today"></div>
                    <span>Today</span>
                </div>
            </div>
        </div><!-- End CALENDAR VIEW -->

        <!-- TRENDS VIEW -->
        <div class="view" id="view-trends" role="tabpanel" aria-labelledby="tab-trends">
            <!-- PMC Chart -->
            <section class="trends-section">
                <h2 class="trends-header">Performance Management Chart (90 Days)</h2>
                <!-- Daily Load Bars -->
                <div class="load-bars" id="load-bars">
                    <!-- Populated by JS -->
                </div>
                <div id="pmc-chart-container">
                    <svg class="trend-chart" id="pmc-chart" viewBox="0 0 800 250" preserveAspectRatio="xMidYMid meet">
                        <!-- Chart populated by JS -->
                    </svg>
                </div>
                <div class="chart-legend">
                    <div class="chart-legend-item">
                        <div class="chart-legend-line load"></div>
                        <span>Daily Load</span>
                    </div>
                    <div class="chart-legend-item">
                        <div class="chart-legend-line ctl"></div>
                        <span>CTL (Fitness)</span>
                    </div>
                    <div class="chart-legend-item">
                        <div class="chart-legend-line atl"></div>
                        <span>ATL (Fatigue)</span>
                    </div>
                    <div class="chart-legend-item">
                        <div class="chart-legend-line tsb"></div>
                        <span>TSB (Form)</span>
                    </div>
                </div>
            </section>

            <!-- Period Stats -->
            <section class="trends-section">
                <h2 class="trends-header">90-Day Summary</h2>
                <div class="stats-grid" id="period-stats">
                    <div class="stat-item">
                        <div class="stat-label">Total TSS</div>
                        <div class="stat-value" id="stat-total-tss">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Avg/Week</div>
                        <div class="stat-value" id="stat-avg-tss">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Activities</div>
                        <div class="stat-value" id="stat-activities">--</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Hours</div>
                        <div class="stat-value" id="stat-hours">--</div>
                    </div>
                </div>
            </section>

            <!-- Weekly Volume Chart -->
            <section class="trends-section">
                <h2 class="trends-header">Weekly Training Volume</h2>
                <div id="volume-chart-container">
                    <svg class="trend-chart" id="volume-chart" viewBox="0 0 800 200" preserveAspectRatio="xMidYMid meet">
                        <!-- Chart populated by JS -->
                    </svg>
                </div>
            </section>
        </div><!-- End TRENDS VIEW -->

        <footer class="footer">
            <div>Generated: <span id="generated-time">--</span></div>
            <div style="margin-top: 8px;">
                <a href="checkin.html">Daily Check-in</a> |
                <a href="athlete-questionnaire.html">Update Profile</a>
            </div>
        </footer>
    </div>

    <script>
        // Dashboard data URL - adjust based on deployment
        const DATA_SOURCES = [
            '../athletes/matti-rowe/dashboard_data.json',  // Local dev
            'https://raw.githubusercontent.com/wattgod/athlete-coaching-system/main/athletes/matti-rowe/dashboard_data.json',  // GitHub raw
        ];

        // Sample data for demo/fallback
        const SAMPLE_DATA = {
            athlete: { name: "Demo Athlete", ftp: 300, weight_kg: 75, phase: "base" },
            readiness: {
                score: 75, max_score: 100, recommendation: "green", color: "#00FF00",
                key_session_eligible: true, session_type_allowed: "key",
                threshold_key: 70, threshold_support: 45,
                ans_quadrant: { number: 2, name: "Q2: Ready to Train", status: "ready_to_train", modifier: 10 },
                score_breakdown: { raw_score: 65, ans_modifier: 10, gate_penalties: 0, final_score: 75 },
                factors: {}
            },
            health_gates: {
                gates: [
                    { name: "sleep", display_name: "Sleep", pass: true, detail: "7.5h" },
                    { name: "energy", display_name: "Energy", pass: true, detail: "" },
                    { name: "autonomic", display_name: "Autonomic", pass: true, detail: "HRV 95%" },
                    { name: "musculoskeletal", display_name: "MSK", pass: true, detail: "soreness: 2/10" },
                    { name: "stress", display_name: "Stress", pass: true, detail: "stress: 3/10" },
                ],
                all_pass: true, intensity_recommendation: "full"
            },
            session: {
                session_type: "key",
                workout: { name: "2x20 Threshold", duration_min: 75, tss_est: 80, category: "threshold" },
                rationale: ["Readiness 75 >= 70 threshold", "All health gates passed"],
                weekly_context: { key_sessions_target: 2, key_sessions_completed: 0, key_sessions_remaining: 2 }
            },
            pmc: { ctl: 45, atl: 52, tsb: -7, ramp_rate: 3.5, trend: "building", tsb_status: "tired", tsb_label: "Tired" },
            recent_training: {
                total_tss: 350, total_hours: 8.5, workouts_completed: 5,
                zone_distribution: {
                    z1_z2: { actual: 82, target: 84 },
                    z3: { actual: 8, target: 6 },
                    z4_plus: { actual: 10, target: 10 }
                }
            },
            blindspots: {
                active_blindspots: ["Movement Quality Gap", "Overtraining Risk"],
                adjustments: { key_threshold: 70, ramp_rate_max: 5.0, tsb_floor: -20, min_rest_days: 2, rhr_offset: 0 },
                daily_reminders: ["Include 10-15min mobility work", "Listen to fatigue signals"]
            },
            weekly_intent: null,
            race_countdown: null,
            alerts: { active: [], resolved_recently: [] }
        };

        async function loadDashboardData() {
            for (const url of DATA_SOURCES) {
                try {
                    const response = await fetch(url);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (e) {
                    console.log(`Failed to load from ${url}:`, e.message);
                }
            }

            // Check localStorage
            const cached = localStorage.getItem('dashboard_data');
            if (cached) {
                try {
                    return JSON.parse(cached);
                } catch (e) {}
            }

            // Return sample data
            console.log('Using sample data');
            return SAMPLE_DATA;
        }

        function formatDate(dateStr) {
            const date = dateStr ? new Date(dateStr) : new Date();
            return date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        function calculateDataFreshness(data) {
            // Check multiple timestamps to determine freshness
            const now = new Date();
            let dataDate = null;
            let dataSource = 'generated';

            // Priority: data_date (from WHOOP import) > generated_at
            if (data._meta?.data_date) {
                dataDate = new Date(data._meta.data_date);
                dataSource = 'synced';
            } else if (data._meta?.generated_at) {
                dataDate = new Date(data._meta.generated_at);
                dataSource = 'generated';
            }

            if (!dataDate) {
                return { status: 'unknown', hoursAgo: null, text: 'Unknown', source: dataSource };
            }

            const hoursAgo = (now - dataDate) / (1000 * 60 * 60);
            const daysAgo = Math.floor(hoursAgo / 24);

            let status, text;
            if (hoursAgo < 12) {
                status = 'fresh';
                if (hoursAgo < 1) {
                    text = `Data ${dataSource} ${Math.round(hoursAgo * 60)} min ago`;
                } else {
                    text = `Data ${dataSource} ${Math.round(hoursAgo)}h ago`;
                }
            } else if (hoursAgo < 24) {
                status = 'fresh';
                text = `Data ${dataSource} ${Math.round(hoursAgo)}h ago`;
            } else if (hoursAgo < 48) {
                status = 'stale';
                text = `Data is ${daysAgo} day old — consider re-syncing`;
            } else {
                status = 'very-stale';
                text = `Data is ${daysAgo} days old — sync required`;
            }

            return { status, hoursAgo, text, source: dataSource, date: dataDate };
        }

        function renderDataFreshness(data) {
            const freshness = calculateDataFreshness(data);
            const el = document.getElementById('data-freshness');
            const textEl = document.getElementById('freshness-text');
            const iconEl = el.querySelector('.freshness-icon');
            const srEl = document.getElementById('freshness-sr');

            el.className = 'data-freshness ' + freshness.status;

            // Icon based on status
            const icons = { fresh: '●', stale: '⚠', 'very-stale': '✗', unknown: '?' };
            iconEl.textContent = icons[freshness.status] || '?';

            textEl.textContent = freshness.text;

            // Screen reader text
            const srTexts = {
                fresh: 'Data is current and up to date',
                stale: 'Warning: Data may be outdated',
                'very-stale': 'Alert: Data is significantly outdated and needs to be refreshed',
                unknown: 'Data freshness could not be determined'
            };
            srEl.textContent = srTexts[freshness.status];
        }

        // Accessible status text mapping
        const STATUS_TEXT = {
            green: { label: 'READY', icon: '✓', description: 'Ready for intensity' },
            yellow: { label: 'CAUTION', icon: '⚠', description: 'Support sessions only' },
            red: { label: 'RECOVER', icon: '✗', description: 'Recovery required' }
        };

        function renderDashboard(data) {
            // Render data freshness first
            renderDataFreshness(data);
            // Header
            document.getElementById('current-date').textContent = formatDate();
            document.getElementById('athlete-name').textContent = data.athlete?.name || 'Athlete';

            // Readiness - with accessible labels
            const readiness = data.readiness;
            const scoreEl = document.getElementById('readiness-score');
            scoreEl.textContent = readiness.score;
            scoreEl.style.color = readiness.color;
            scoreEl.setAttribute('aria-label', `Readiness score: ${readiness.score} out of 100`);

            const statusEl = document.getElementById('readiness-status');
            const statusInfo = STATUS_TEXT[readiness.recommendation] || STATUS_TEXT.yellow;

            // Include icon + text label for accessibility (not just color)
            const statusText = readiness.key_session_eligible
                ? `${statusInfo.icon} ${statusInfo.label} — Key Session Eligible`
                : `${statusInfo.icon} ${statusInfo.label} — ${readiness.session_type_allowed.toUpperCase()} Only`;

            statusEl.textContent = statusText;
            statusEl.className = 'readiness-status ' + readiness.recommendation;
            statusEl.setAttribute('aria-label', `Status: ${statusInfo.label}. ${statusInfo.description}`);

            // Screen reader announcement
            document.getElementById('readiness-sr').textContent =
                `Readiness score is ${readiness.score}. Status: ${statusInfo.label}. ${statusInfo.description}`;

            const ansBadge = document.getElementById('ans-badge');
            ansBadge.textContent = readiness.ans_quadrant.name;
            ansBadge.setAttribute('aria-label', `Autonomic nervous system status: ${readiness.ans_quadrant.name}`);

            // Score breakdown
            const factors = readiness.factors || {};
            let breakdownHtml = '';
            for (const [key, factor] of Object.entries(factors)) {
                if (factor.contribution !== undefined) {
                    const impact = factor.impact || 'neutral';
                    const valueClass = impact.includes('positive') ? 'positive' : (impact.includes('negative') ? 'negative' : '');
                    breakdownHtml += `
                        <div class="factor-row">
                            <span class="factor-name">${key.replace('_', ' ')}</span>
                            <span class="factor-value ${valueClass}">+${factor.contribution.toFixed(1)}</span>
                        </div>
                    `;
                }
            }
            document.getElementById('score-breakdown').innerHTML = breakdownHtml;

            // Health Gates - with accessibility
            const gates = data.health_gates;
            let gatesHtml = '';
            for (const gate of gates.gates) {
                const passStatus = gate.pass ? 'PASS' : 'FAIL';
                const passIcon = gate.pass ? '✓' : '✗';
                const ariaLabel = `${gate.display_name}: ${passStatus}${gate.detail ? '. ' + gate.detail : ''}`;

                gatesHtml += `
                    <div class="gate-item ${gate.pass ? 'pass' : 'fail'}"
                         role="listitem"
                         aria-label="${ariaLabel}">
                        <div class="gate-icon" aria-hidden="true">${passIcon}</div>
                        <div class="gate-name">${gate.display_name}</div>
                        <div class="gate-status" style="font-size:9px;font-weight:700;margin-top:2px;">${passStatus}</div>
                        ${gate.detail ? `<div class="gate-detail">${gate.detail}</div>` : ''}
                    </div>
                `;
            }
            document.getElementById('gates-grid').innerHTML = gatesHtml;

            const gatesOverallEl = document.getElementById('gates-overall');
            const gatesOverallText = gates.all_pass
                ? `✓ ALL GATES PASS — ${gates.intensity_recommendation.toUpperCase()} INTENSITY`
                : '✗ GATES FAILED — RECOVERY ONLY';
            gatesOverallEl.textContent = gatesOverallText;
            gatesOverallEl.setAttribute('aria-label', gates.all_pass
                ? 'All health gates passed. Full intensity training allowed.'
                : 'One or more health gates failed. Recovery only recommended.');

            // Session
            const session = data.session;
            document.getElementById('session-type').textContent = session.session_type.toUpperCase() + ' SESSION';
            document.getElementById('session-workout').textContent = session.workout.name;

            let metaHtml = `
                <div class="session-meta-item">
                    <span class="session-meta-label">Duration: </span>
                    <span class="session-meta-value">${session.workout.duration_min} min</span>
                </div>
                <div class="session-meta-item">
                    <span class="session-meta-label">Est. TSS: </span>
                    <span class="session-meta-value">${session.workout.tss_est}</span>
                </div>
            `;
            if (session.weekly_context) {
                metaHtml += `
                    <div class="session-meta-item">
                        <span class="session-meta-label">Key Sessions: </span>
                        <span class="session-meta-value">${session.weekly_context.key_sessions_completed}/${session.weekly_context.key_sessions_target}</span>
                    </div>
                `;
            }
            document.getElementById('session-meta').innerHTML = metaHtml;

            let rationaleHtml = '';
            for (const r of session.rationale || []) {
                rationaleHtml += `<div class="rationale-item">• ${r}</div>`;
            }
            document.getElementById('session-rationale').innerHTML = rationaleHtml;

            // PMC
            const pmc = data.pmc;
            document.getElementById('pmc-ctl').textContent = pmc.ctl.toFixed(1);
            document.getElementById('pmc-atl').textContent = pmc.atl.toFixed(1);
            document.getElementById('pmc-tsb').textContent = pmc.tsb.toFixed(1);
            document.getElementById('tsb-status').textContent = pmc.tsb_label || 'Form';
            document.getElementById('ramp-rate').textContent = pmc.ramp_rate.toFixed(1);
            document.getElementById('trend').textContent = pmc.trend.toUpperCase();

            // Recent Training
            const recent = data.recent_training;
            document.getElementById('total-tss').textContent = recent.total_tss;
            document.getElementById('total-hours').textContent = recent.total_hours.toFixed(1);
            document.getElementById('workouts-count').textContent = recent.workouts_completed;

            const zones = recent.zone_distribution;
            let zonesHtml = '';
            const zoneLabels = { z1_z2: 'Z1-Z2', z3: 'Z3', z4_plus: 'Z4+' };
            for (const [zone, data] of Object.entries(zones)) {
                const pct = Math.min(data.actual, 100);
                const targetPct = data.target;
                zonesHtml += `
                    <div class="zone-row">
                        <div class="zone-label">${zoneLabels[zone]}</div>
                        <div class="zone-bar-container">
                            <div class="zone-bar-fill" style="width: ${pct}%;"></div>
                            <div class="zone-bar-target" style="left: ${targetPct}%;"></div>
                        </div>
                        <div class="zone-value">${data.actual}% / ${data.target}%</div>
                    </div>
                `;
            }
            document.getElementById('zone-bars').innerHTML = zonesHtml;

            // Blindspots
            const blindspots = data.blindspots;
            if (blindspots.active_blindspots.length > 0) {
                let bsHtml = '';
                for (const bs of blindspots.active_blindspots) {
                    bsHtml += `<span class="blindspot-tag">${bs}</span>`;
                }
                document.getElementById('blindspot-list').innerHTML = bsHtml;

                const adj = blindspots.adjustments;
                document.getElementById('adjustments-table').innerHTML = `
                    <tr><td>Key Session Threshold</td><td>${adj.key_threshold}</td></tr>
                    <tr><td>Max Ramp Rate</td><td>${adj.ramp_rate_max} TSS/day</td></tr>
                    <tr><td>TSB Floor</td><td>${adj.tsb_floor}</td></tr>
                    <tr><td>Min Rest Days</td><td>${adj.min_rest_days}/week</td></tr>
                    ${adj.rhr_offset ? `<tr><td>RHR Offset</td><td>+${adj.rhr_offset} bpm</td></tr>` : ''}
                `;

                if (blindspots.daily_reminders && blindspots.daily_reminders.length > 0) {
                    const remindersEl = document.getElementById('reminders');
                    remindersEl.style.display = 'block';
                    let remHtml = '';
                    for (const rem of blindspots.daily_reminders) {
                        remHtml += `<div class="reminder-item">${rem}</div>`;
                    }
                    document.getElementById('reminders-list').innerHTML = remHtml;
                }
            } else {
                document.getElementById('blindspots-section').style.display = 'none';
            }

            // Weekly Intent
            const intent = data.weekly_intent;
            if (intent) {
                document.getElementById('weekly-intent-section').style.display = 'block';
                const ks = intent.key_sessions;
                const vol = intent.volume;
                document.getElementById('intent-grid').innerHTML = `
                    <div class="intent-item">
                        <div class="intent-label">Key Sessions</div>
                        <div class="intent-value">${ks.remaining} <small>remaining of ${ks.target}</small></div>
                    </div>
                    <div class="intent-item">
                        <div class="intent-label">Aerobic Volume</div>
                        <div class="intent-value">${vol.aerobic_hours_range[0]}-${vol.aerobic_hours_range[1]} <small>hours</small></div>
                    </div>
                    <div class="intent-item">
                        <div class="intent-label">Max TSS</div>
                        <div class="intent-value">${vol.max_tss}</div>
                    </div>
                    <div class="intent-item">
                        <div class="intent-label">Priority</div>
                        <div class="intent-value" style="font-size: 12px;">${intent.priority}</div>
                    </div>
                `;
            }

            // Race Countdown
            const race = data.race_countdown;
            if (race && race.race) {
                document.getElementById('race-section').style.display = 'block';
                document.getElementById('race-name').textContent = race.race.name;
                document.getElementById('race-date').textContent = race.race.date;
                document.getElementById('days-to-race').textContent = race.race.days_to;

                const ctl = race.ctl_trajectory;
                document.getElementById('ctl-current').textContent = ctl.current;
                document.getElementById('ctl-target').textContent = ctl.target;
                document.getElementById('ctl-bar-fill').style.width = `${Math.min(ctl.pct_complete, 100)}%`;
            }

            // Alerts
            const alerts = data.alerts;
            if (alerts.active && alerts.active.length > 0) {
                let alertsHtml = '';
                for (const alert of alerts.active) {
                    alertsHtml += `<div class="alert-item">${alert}</div>`;
                }
                document.getElementById('alerts-container').innerHTML = alertsHtml;
            }

            // Generated time
            if (data._meta?.generated_at) {
                const genDate = new Date(data._meta.generated_at);
                document.getElementById('generated-time').textContent = genDate.toLocaleString();
            }
        }

        // =============================================
        // TAB NAVIGATION
        // =============================================
        let currentData = null;
        let calendarMonth = new Date();

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.view));
            });
        }

        function switchTab(viewName) {
            // Update tabs
            document.querySelectorAll('.tab').forEach(tab => {
                const isActive = tab.dataset.view === viewName;
                tab.classList.toggle('active', isActive);
                tab.setAttribute('aria-selected', isActive);
            });

            // Update views
            document.querySelectorAll('.view').forEach(view => {
                view.classList.toggle('active', view.id === `view-${viewName}`);
            });

            // Render view-specific content
            if (viewName === 'calendar' && currentData) {
                renderCalendar(currentData);
            } else if (viewName === 'trends' && currentData) {
                renderTrends(currentData);
            }
        }

        // =============================================
        // CALENDAR VIEW
        // =============================================
        function initCalendarNav() {
            document.getElementById('prev-month').addEventListener('click', () => {
                calendarMonth.setMonth(calendarMonth.getMonth() - 1);
                renderCalendar(currentData);
            });
            document.getElementById('next-month').addEventListener('click', () => {
                calendarMonth.setMonth(calendarMonth.getMonth() + 1);
                renderCalendar(currentData);
            });
        }

        function renderWeeklyProgress(data, activities) {
            // Get current week's Monday
            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - ((today.getDay() + 6) % 7));
            monday.setHours(0, 0, 0, 0);

            const sunday = new Date(monday);
            sunday.setDate(monday.getDate() + 6);

            // Calculate this week's TSS
            let weeklyTSS = 0;
            activities.forEach(a => {
                const actDate = new Date(a.date);
                if (actDate >= monday && actDate <= sunday) {
                    weeklyTSS += a.tss || 0;
                }
            });

            // Get target from weekly_intent or default
            const targetTSS = data.weekly_intent?.volume?.max_tss || 400;
            const pct = Math.min((weeklyTSS / targetTSS) * 100, 150);

            // Update progress bar
            const fillEl = document.getElementById('weekly-progress-fill');
            fillEl.style.width = `${Math.min(pct, 100)}%`;

            // Color based on progress
            fillEl.classList.remove('under', 'on-target', 'over');
            if (pct < 70) {
                fillEl.classList.add('under');
            } else if (pct > 110) {
                fillEl.classList.add('over');
            } else {
                fillEl.classList.add('on-target');
            }

            // Update text
            document.getElementById('weekly-progress-text').textContent = `${weeklyTSS} / ${targetTSS} TSS`;

            // Position target line at 100%
            document.getElementById('weekly-target-line').style.left = '100%';
        }

        // Generate intensity bar for an activity (skyline-inspired)
        function getIntensityBar(activity) {
            // Simulate zone distribution based on TSS and intensity
            const intensity = activity.intensity || 0.7;
            const tss = activity.tss || 50;

            // Higher intensity = more time in higher zones
            let bars = '';
            if (intensity < 0.65) {
                // Easy ride - mostly Z1-Z2
                bars = '<div class="intensity-bar z1"></div>'.repeat(2) +
                       '<div class="intensity-bar z2"></div>'.repeat(3);
            } else if (intensity < 0.80) {
                // Tempo - Z2-Z3
                bars = '<div class="intensity-bar z2"></div>'.repeat(2) +
                       '<div class="intensity-bar z3"></div>'.repeat(2) +
                       '<div class="intensity-bar z2"></div>';
            } else if (intensity < 0.90) {
                // Threshold - Z3-Z4
                bars = '<div class="intensity-bar z2"></div>' +
                       '<div class="intensity-bar z3"></div>'.repeat(2) +
                       '<div class="intensity-bar z4"></div>' +
                       '<div class="intensity-bar z3"></div>';
            } else {
                // VO2max - Z4-Z5
                bars = '<div class="intensity-bar z3"></div>' +
                       '<div class="intensity-bar z4"></div>'.repeat(2) +
                       '<div class="intensity-bar z5"></div>' +
                       '<div class="intensity-bar z4"></div>';
            }

            return `<div class="activity-intensity">${bars}</div>`;
        }

        function renderCalendar(data) {
            const year = calendarMonth.getFullYear();
            const month = calendarMonth.getMonth();

            // Update month label
            const monthName = calendarMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            document.getElementById('calendar-month-label').textContent = monthName.toUpperCase();

            // Get activities and races for this month
            const activities = data.history?.activities || [];
            const races = data.history?.races || data.race_countdown?.upcoming_races || [];

            // Build activity lookup by date
            const activityByDate = {};
            activities.forEach(a => {
                if (!activityByDate[a.date]) activityByDate[a.date] = [];
                activityByDate[a.date].push(a);
            });

            // Calculate weekly progress for current week
            renderWeeklyProgress(data, activities);

            // Build race lookup by date
            const raceByDate = {};
            races.forEach(r => {
                raceByDate[r.date] = r;
            });

            // Calculate calendar grid
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = (firstDay.getDay() + 6) % 7; // Monday = 0
            const daysInMonth = lastDay.getDate();

            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // Build grid HTML (keep headers)
            let gridHtml = `
                <div class="calendar-header" role="columnheader">Mon</div>
                <div class="calendar-header" role="columnheader">Tue</div>
                <div class="calendar-header" role="columnheader">Wed</div>
                <div class="calendar-header" role="columnheader">Thu</div>
                <div class="calendar-header" role="columnheader">Fri</div>
                <div class="calendar-header" role="columnheader">Sat</div>
                <div class="calendar-header" role="columnheader">Sun</div>
            `;

            // Empty cells before first day
            for (let i = 0; i < startDayOfWeek; i++) {
                gridHtml += '<div class="calendar-day empty"></div>';
            }

            // Days of month
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const isToday = dateStr === todayStr;
                const hasRace = raceByDate[dateStr];
                const dayActivities = activityByDate[dateStr] || [];

                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (hasRace) classes += ' race-day';

                gridHtml += `<div class="${classes}" role="gridcell">`;
                gridHtml += `<div class="calendar-day-number">${day}</div>`;

                // Render activities (limit to 2)
                dayActivities.slice(0, 2).forEach(activity => {
                    const name = activity.name?.length > 12 ? activity.name.substring(0, 12) + '...' : activity.name;
                    gridHtml += `<div class="calendar-workout" title="${activity.name}">${name}</div>`;
                    if (activity.tss) {
                        gridHtml += `<div class="calendar-tss">${activity.tss} TSS</div>`;
                    }
                    // Add intensity bar (skyline-inspired)
                    gridHtml += getIntensityBar(activity);
                });

                // Render race
                if (hasRace) {
                    const priority = hasRace.priority || 'C';
                    gridHtml += `<div class="calendar-race">${priority} ${hasRace.name?.substring(0, 10) || 'Race'}</div>`;
                }

                gridHtml += '</div>';
            }

            // Empty cells after last day
            const totalCells = startDayOfWeek + daysInMonth;
            const remainingCells = (7 - (totalCells % 7)) % 7;
            for (let i = 0; i < remainingCells; i++) {
                gridHtml += '<div class="calendar-day empty"></div>';
            }

            document.getElementById('calendar-grid').innerHTML = gridHtml;
        }

        // =============================================
        // TRENDS VIEW
        // =============================================
        function renderTrends(data) {
            const pmcData = data.history?.pmc || [];
            const activities = data.history?.activities || [];

            if (pmcData.length === 0) {
                document.getElementById('pmc-chart-container').innerHTML =
                    '<div class="chart-no-data">No PMC data available — run generate_dashboard.py --include-history</div>';
                document.getElementById('volume-chart-container').innerHTML =
                    '<div class="chart-no-data">No activity data available</div>';
                document.getElementById('load-bars').innerHTML = '';
                return;
            }

            renderLoadBars(pmcData, activities);
            renderPMCChart(pmcData);
            renderPeriodStats(pmcData, activities);
            renderVolumeChart(activities);
        }

        function renderLoadBars(pmcData, activities) {
            // Build activity TSS lookup by date
            const tssByDate = {};
            activities.forEach(a => {
                tssByDate[a.date] = (tssByDate[a.date] || 0) + (a.tss || 0);
            });

            // Get max TSS for scaling
            const maxTSS = Math.max(...Object.values(tssByDate), 50);

            // Render bars for each day in PMC data
            let barsHtml = '';
            pmcData.forEach(day => {
                const tss = tssByDate[day.date] || 0;
                const height = tss > 0 ? Math.max(4, (tss / maxTSS) * 100) : 0;
                barsHtml += `<div class="load-bar" style="height: ${height}%" title="${day.date}: ${tss} TSS"></div>`;
            });

            document.getElementById('load-bars').innerHTML = barsHtml;
        }

        function renderPMCChart(pmcData) {
            const svg = document.getElementById('pmc-chart');
            const width = 800;
            const height = 250;
            const padding = { top: 20, right: 50, bottom: 30, left: 50 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            // Filter to valid data points
            const validData = pmcData.filter(d => d.ctl !== null || d.atl !== null);
            if (validData.length === 0) {
                document.getElementById('pmc-chart-container').innerHTML =
                    '<div class="chart-no-data">No valid PMC data points</div>';
                return;
            }

            // Calculate ranges
            const ctlValues = validData.map(d => d.ctl).filter(v => v !== null);
            const atlValues = validData.map(d => d.atl).filter(v => v !== null);
            const tsbValues = validData.map(d => d.tsb).filter(v => v !== null);

            const allValues = [...ctlValues, ...atlValues, ...tsbValues];
            const minVal = Math.min(...allValues, 0) - 10;
            const maxVal = Math.max(...allValues) + 10;

            // Scale functions
            const xScale = (i) => padding.left + (i / (validData.length - 1)) * chartWidth;
            const yScale = (v) => padding.top + chartHeight - ((v - minVal) / (maxVal - minVal)) * chartHeight;

            // Build SVG paths
            let ctlPath = '';
            let atlPath = '';
            let tsbPath = '';

            validData.forEach((d, i) => {
                const x = xScale(i);
                if (d.ctl !== null) {
                    ctlPath += (ctlPath ? 'L' : 'M') + `${x},${yScale(d.ctl)}`;
                }
                if (d.atl !== null) {
                    atlPath += (atlPath ? 'L' : 'M') + `${x},${yScale(d.atl)}`;
                }
                if (d.tsb !== null) {
                    tsbPath += (tsbPath ? 'L' : 'M') + `${x},${yScale(d.tsb)}`;
                }
            });

            // Zero line for TSB
            const zeroY = yScale(0);

            // Axis labels
            const firstDate = validData[0].date;
            const lastDate = validData[validData.length - 1].date;

            // TSB zone backgrounds (Intervals.icu style)
            const freshY = yScale(25);  // Fresh zone: TSB > 25
            const optimalTopY = yScale(15);  // Optimal: 5-15
            const optimalBotY = yScale(5);
            const grayTopY = yScale(-5);  // Gray zone: -5 to 5
            const riskY = yScale(-20);  // Risk zone: TSB < -20

            svg.innerHTML = `
                <!-- TSB Zone Backgrounds -->
                <rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${freshY - padding.top}"
                      fill="rgba(76, 175, 80, 0.1)" />
                <rect x="${padding.left}" y="${freshY}" width="${chartWidth}" height="${optimalTopY - freshY}"
                      fill="rgba(76, 175, 80, 0.2)" />
                <rect x="${padding.left}" y="${optimalBotY}" width="${chartWidth}" height="${grayTopY - optimalBotY}"
                      fill="rgba(158, 158, 158, 0.1)" />
                <rect x="${padding.left}" y="${grayTopY}" width="${chartWidth}" height="${height - padding.bottom - grayTopY}"
                      fill="rgba(244, 67, 54, 0.1)" />

                <!-- Grid lines -->
                <line x1="${padding.left}" y1="${zeroY}" x2="${width - padding.right}" y2="${zeroY}"
                      stroke="#999" stroke-width="1"/>

                <!-- Axis -->
                <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}"
                      stroke="#000" stroke-width="2"/>
                <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}"
                      stroke="#000" stroke-width="2"/>

                <!-- Y-axis labels -->
                <text x="${padding.left - 10}" y="${padding.top + 5}" font-family="Sometype Mono" font-size="10" text-anchor="end">${Math.round(maxVal)}</text>
                <text x="${padding.left - 10}" y="${zeroY + 4}" font-family="Sometype Mono" font-size="10" text-anchor="end">0</text>
                <text x="${padding.left - 10}" y="${height - padding.bottom}" font-family="Sometype Mono" font-size="10" text-anchor="end">${Math.round(minVal)}</text>

                <!-- X-axis labels -->
                <text x="${padding.left}" y="${height - 8}" font-family="Sometype Mono" font-size="9" text-anchor="start">${firstDate}</text>
                <text x="${width - padding.right}" y="${height - 8}" font-family="Sometype Mono" font-size="9" text-anchor="end">${lastDate}</text>

                <!-- Data lines (Intervals.icu colors) -->
                <path d="${ctlPath}" fill="none" stroke="#2196F3" stroke-width="2.5"/>
                <path d="${atlPath}" fill="none" stroke="#E91E63" stroke-width="2" stroke-dasharray="6,3"/>
                <path d="${tsbPath}" fill="none" stroke="#FFC107" stroke-width="2"/>

                <!-- Zone labels -->
                <text x="${width - padding.right - 5}" y="${freshY - 5}" font-family="Sometype Mono" font-size="8" fill="#4CAF50" text-anchor="end">FRESH</text>
                <text x="${width - padding.right - 5}" y="${optimalTopY + 12}" font-family="Sometype Mono" font-size="8" fill="#4CAF50" text-anchor="end">OPTIMAL</text>
                <text x="${width - padding.right - 5}" y="${riskY + 12}" font-family="Sometype Mono" font-size="8" fill="#F44336" text-anchor="end">RISK</text>

                <!-- Current values -->
                <text x="${width - padding.right + 5}" y="${yScale(ctlValues[ctlValues.length - 1])}"
                      font-family="Sometype Mono" font-size="10" fill="#2196F3" font-weight="bold">${Math.round(ctlValues[ctlValues.length - 1])}</text>
                <text x="${width - padding.right + 5}" y="${yScale(atlValues[atlValues.length - 1])}"
                      font-family="Sometype Mono" font-size="10" fill="#E91E63" font-weight="bold">${Math.round(atlValues[atlValues.length - 1])}</text>
                <text x="${width - padding.right + 5}" y="${yScale(tsbValues[tsbValues.length - 1])}"
                      font-family="Sometype Mono" font-size="10" fill="#FFC107" font-weight="bold">${Math.round(tsbValues[tsbValues.length - 1])}</text>
            `;
        }

        function renderPeriodStats(pmcData, activities) {
            // Calculate total TSS from activities
            const totalTSS = activities.reduce((sum, a) => sum + (a.tss || 0), 0);
            const totalHours = activities.reduce((sum, a) => sum + (a.duration_minutes || 0) / 60, 0);
            const weeks = Math.max(1, pmcData.length / 7);
            const avgWeeklyTSS = Math.round(totalTSS / weeks);

            document.getElementById('stat-total-tss').textContent = totalTSS;
            document.getElementById('stat-avg-tss').textContent = avgWeeklyTSS;
            document.getElementById('stat-activities').textContent = activities.length;
            document.getElementById('stat-hours').textContent = totalHours.toFixed(1);
        }

        function renderVolumeChart(activities) {
            const svg = document.getElementById('volume-chart');
            const width = 800;
            const height = 200;
            const padding = { top: 20, right: 20, bottom: 40, left: 50 };

            if (activities.length === 0) {
                document.getElementById('volume-chart-container').innerHTML =
                    '<div class="chart-no-data">No activity data available</div>';
                return;
            }

            // Group by week
            const weeklyTSS = {};
            activities.forEach(a => {
                const date = new Date(a.date);
                const weekStart = new Date(date);
                weekStart.setDate(date.getDate() - date.getDay() + 1); // Monday
                const weekKey = weekStart.toISOString().split('T')[0];
                weeklyTSS[weekKey] = (weeklyTSS[weekKey] || 0) + (a.tss || 0);
            });

            const weeks = Object.entries(weeklyTSS).sort((a, b) => a[0].localeCompare(b[0]));
            if (weeks.length === 0) {
                document.getElementById('volume-chart-container').innerHTML =
                    '<div class="chart-no-data">No weekly data available</div>';
                return;
            }

            const maxTSS = Math.max(...weeks.map(w => w[1]));
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;
            const barWidth = Math.min(40, chartWidth / weeks.length - 4);

            let barsHtml = '';
            weeks.forEach(([week, tss], i) => {
                const x = padding.left + (i * chartWidth / weeks.length) + (chartWidth / weeks.length - barWidth) / 2;
                const barHeight = (tss / maxTSS) * chartHeight;
                const y = padding.top + chartHeight - barHeight;

                barsHtml += `
                    <rect x="${x}" y="${y}" width="${barWidth}" height="${barHeight}"
                          fill="#000" stroke="#000" stroke-width="1"/>
                    <text x="${x + barWidth / 2}" y="${y - 5}"
                          font-family="Sometype Mono" font-size="9" text-anchor="middle">${tss}</text>
                `;

                // Week label
                const weekLabel = week.substring(5); // MM-DD
                barsHtml += `
                    <text x="${x + barWidth / 2}" y="${height - 10}"
                          font-family="Sometype Mono" font-size="8" text-anchor="middle"
                          transform="rotate(-45, ${x + barWidth / 2}, ${height - 10})">${weekLabel}</text>
                `;
            });

            svg.innerHTML = `
                <!-- Axis -->
                <line x1="${padding.left}" y1="${padding.top}" x2="${padding.left}" y2="${height - padding.bottom}"
                      stroke="#000" stroke-width="2"/>
                <line x1="${padding.left}" y1="${height - padding.bottom}" x2="${width - padding.right}" y2="${height - padding.bottom}"
                      stroke="#000" stroke-width="2"/>

                <!-- Y-axis label -->
                <text x="${padding.left - 10}" y="${padding.top + 5}" font-family="Sometype Mono" font-size="10" text-anchor="end">${maxTSS}</text>
                <text x="${padding.left - 10}" y="${height - padding.bottom}" font-family="Sometype Mono" font-size="10" text-anchor="end">0</text>

                <!-- Y-axis title -->
                <text x="15" y="${height / 2}" font-family="Sometype Mono" font-size="10"
                      transform="rotate(-90, 15, ${height / 2})" text-anchor="middle">TSS</text>

                ${barsHtml}
            `;
        }

        // =============================================
        // INITIALIZATION
        // =============================================
        initTabs();
        initCalendarNav();

        // Load and render
        loadDashboardData().then(data => {
            currentData = data;
            renderDashboard(data);
            // Cache for offline use
            localStorage.setItem('dashboard_data', JSON.stringify(data));
        }).catch(err => {
            console.error('Failed to load dashboard:', err);
            currentData = SAMPLE_DATA;
            renderDashboard(SAMPLE_DATA);
        });
    </script>
</body>
</html>
